<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק הגדרות ומשפטים - אינפי 1מ'</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <!-- MathJax for rendering LaTeX -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Confetti for winning -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f3f4f6;
            user-select: none;
        }

        .drop-zone {
            display: inline-block;
            min-width: 80px;
            height: 40px;
            border-bottom: 2px dashed #3b82f6;
            margin: 0 5px;
            vertical-align: middle;
            background-color: #eef2ff;
            border-radius: 4px;
            transition: all 0.2s;
            text-align: center;
            padding: 0 5px;
            cursor: pointer;
        }

        .drop-zone.hovered {
            background-color: #dbeafe;
            border-color: #1d4ed8;
            transform: scale(1.05);
        }

        .drop-zone.correct {
            border-bottom: 2px solid #22c55e;
            background-color: #dcfce7;
            color: #15803d;
        }

        .drop-zone.wrong {
            border-bottom: 2px solid #ef4444;
            background-color: #fee2e2;
            animation: shake 0.5s;
        }

        .draggable-item {
            cursor: grab;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .draggable-item:active {
            cursor: grabbing;
        }

        .draggable-item.selected {
            background-color: #bfdbfe;
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        /* MathJax overrides to fit inline properly */
        mjx-container {
            font-size: 110% !important;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
        <div>
            <h1 class="text-xl font-bold text-gray-800">משחק הגדרות ומשפטים</h1>
            <p class="text-sm text-gray-500">אינפי 1מ' - תרגול מקיף</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-lg font-semibold text-blue-600">
                שלב <span id="level-indicator">1</span> מתוך 20
            </div>
        </div>
    </header>

    <!-- Main Game Area -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 relative w-full max-w-4xl mx-auto">
        
        <!-- Game Container -->
        <div id="game-board" class="bg-white rounded-xl shadow-lg p-8 w-full min-h-[400px] flex flex-col justify-between fade-in relative">
            
            <!-- Instructions -->
            <div class="mb-6 text-center text-gray-600">
                גררו את המילים המתאימות למקומות הריקים כדי להשלים את ההגדרה/המשפט.
            </div>

            <!-- The Theorem/Definition Text -->
            <div class="text-xl md:text-2xl leading-loose text-gray-800 text-center mb-10" id="sentence-container">
                <!-- Content injected via JS -->
            </div>

            <!-- Feedback Message -->
            <div id="feedback" class="h-8 text-center font-bold text-lg mb-4"></div>

            <!-- Word Bank -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h3 class="text-sm font-semibold text-gray-500 mb-3">מחסן מילים (כולל מסיחים):</h3>
                <div id="word-bank" class="flex flex-wrap gap-3 justify-center min-h-[60px]">
                    <!-- Draggables injected via JS -->
                </div>
            </div>

            <!-- Controls -->
            <div class="mt-6 flex justify-center gap-4">
                <button onclick="resetLevel()" class="px-6 py-2 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100 transition">
                    נקה הכל
                </button>
                <button onclick="checkAnswer()" class="px-8 py-2 rounded-full bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md transition transform hover:scale-105">
                    בדיקה
                </button>
                <button id="next-btn" onclick="nextLevel()" class="hidden px-8 py-2 rounded-full bg-green-600 text-white font-bold hover:bg-green-700 shadow-md transition animate-bounce">
                    לשלב הבא &larr;
                </button>
            </div>
        </div>

        <!-- Completion Modal -->
        <div id="end-screen" class="hidden absolute inset-0 bg-white z-50 flex flex-col items-center justify-center text-center p-8">
            <h2 class="text-4xl font-bold text-blue-600 mb-4">סיימת את כל המסלול!</h2>
            <p class="text-xl text-gray-600 mb-8">עברת בהצלחה על כל נושאי הקורס.</p>
            <button onclick="restartGame()" class="px-8 py-3 rounded-full bg-blue-600 text-white text-lg font-bold hover:bg-blue-700 shadow-lg">
                התחל מחדש
            </button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 p-3 text-center text-gray-500 text-sm">
        נוצר בהשראת MathSlides | תואם סילבוס אינפי 1מ'
    </footer>

    <script>
        // --- Game Data ---
        // 20 Levels covering Infi 1m Syllabus
        const levels = [
            // Week 1: Supremum
            {
                id: 1,
                title: "הגדרת הסופרמום (Supremum)",
                template: `תהי $A$ קבוצה חסומה מלעיל. המספר $M$ נקרא סופרמום של $A$ אם הוא {{0}} מלעיל של $A$, וגם לכל $\\varepsilon > 0$ {{1}} $a \\in A$ כך ש-{{2}}.`,
                answers: ["חסם", "קיים", "$a > M - \\varepsilon$"],
                distractors: ["מקסימום", "לכל", "$a < M - \\varepsilon$", "חסומה", "אינפימום", "$a > M$", "מינימום"]
            },
            // Week 2: Limit Definition
            {
                id: 2,
                title: "הגדרת גבול של סדרה",
                template: `תהי $a_n$ סדרה. נאמר ש-$L$ הוא הגבול של הסדרה אם {{0}} $\\varepsilon > 0$ {{1}} $N$ כך ש{{2}} $n > N$ מתקיים {{3}}.`,
                answers: ["לכל", "קיים", "לכל", "$|a_n - L| < \\varepsilon$"],
                distractors: ["טבעי", "ממשי", "גדול מ-", "$|a_n - L| > \\varepsilon$", "$a_n > L$", "יחיד", "שלם", "עבור"]
            },
            // Week 4: Monotonic Convergence
            {
                id: 3,
                title: "משפט ההתכנסות המונוטונית",
                template: `תהי $a_n$ סדרה {{0}} ו-{{1}}, אזי הסדרה {{2}} (במובן הצר).`,
                answers: ["מונוטונית", "חסומה", "מתכנסת"],
                distractors: ["חיובית", "יורדת", "מתבדרת", "סדרת קושי", "רציפה", "עולה ממש", "לא חסומה"]
            },
            // Week 4: Bolzano-Weierstrass
            {
                id: 4,
                title: "משפט בולצאנו-ויירשטראס",
                template: `לכל סדרה {{0}} קיימת {{1}} {{2}}.`,
                answers: ["חסומה", "תת-סדרה", "מתכנסת"],
                distractors: ["מונוטונית", "סדרה", "מתבדרת", "חיובית", "קבועה", "רציפה", "שלמה"]
            },
            // Week 5: Cauchy Sequence
            {
                id: 5,
                title: "הגדרת סדרת קושי",
                template: `סדרה $a_n$ נקראת סדרת קושי אם לכל $\\varepsilon > 0$ {{0}} $N$ כך ש{{1}} $n,m > N$ מתקיים {{2}}.`,
                answers: ["קיים", "לכל", "$|a_n - a_m| < \\varepsilon$"],
                distractors: ["טבעי", "לכל", "קיים", "$|a_n - L| < \\varepsilon$", "$a_n \\to 0$", "עבור", "שואף ל-", "$|a_n| < \\varepsilon$"]
            },
            // Week 7: Heine Definition of Limit
            {
                id: 6,
                title: "הגדרת הגבול של פונקציה לפי היינה",
                template: `$\\lim_{x \\to x_0} f(x) = L$ אם ורק אם לכל {{0}} $x_n$ המקיימת $x_n \\neq x_0$ ו-{{1}}, מתקיים {{2}}.`,
                answers: ["סדרה", "$x_n \\to x_0$", "$f(x_n) \\to L$"],
                distractors: ["פונקציה", "$x_n \\to L$", "$f(x_n) \\to x_0$", "סביבה", "נקודה", "רציפה", "חסומה"]
            },
            // Week 8: Continuity Definition (Cauchy)
            {
                id: 7,
                title: "רציפות בנקודה (הגדרת קושי)",
                template: `פונקציה $f$ רציפה בנקודה $x_0$ אם {{0}} $\\varepsilon > 0$ קיים $\\delta > 0$ כך ש{{1}} $x$ המקיים {{2}} מתקיים {{3}}.`,
                answers: ["לכל", "לכל", "$|x - x_0| < \\delta$", "$|f(x) - f(x_0)| < \\varepsilon$"],
                distractors: ["קיים", "קיים", "$x > \\delta$", "$f(x) \\neq 0$", "$|x| < \\delta$", "$|f(x)| > \\varepsilon$", "עבור", "סביבה"]
            },
            // Week 8: Intermediate Value Theorem
            {
                id: 8,
                title: "משפט ערך הביניים",
                template: `תהי $f$ רציפה בקטע {{0}} $[a,b]$. אם $f(a) \\cdot f(b) < 0$ אזי {{1}} $c \\in (a,b)$ כך ש-{{2}}.`,
                answers: ["סגור", "קיימת", "$f(c) = 0$"],
                distractors: ["פתוח", "לכל", "$f'(c) = 0$", "$f(c) > 0$", "נקודה", "יחידה", "חסומה"]
            },
            // Week 9: Weierstrass Theorems
            {
                id: 9,
                title: "משפט ויירשטראס השני (מקסימום ומינימום)",
                template: `אם $f$ פונקציה {{0}} בקטע {{1}} $[a,b]$, אזי היא {{2}} באותו קטע ומקבלת בו {{3}} ומינימום.`,
                answers: ["רציפה", "סגור", "חסומה", "מקסימום"],
                distractors: ["גזירה", "פתוח", "מונוטונית", "ערך ביניים", "קבועה", "אינסוף", "אפס", "נקודת פיתול"]
            },
            // Week 9: Uniform Continuity
            {
                id: 10,
                title: "רציפות במידה שווה (Definition)",
                template: `$f$ רציפה במידה שווה ב-$I$ אם לכל $\\varepsilon > 0$ {{0}} $\\delta > 0$ כך שלכל $x_1, x_2 \\in I$ המקיימים {{1}} מתקיים {{2}}.`,
                answers: ["קיים", "$|x_1 - x_2| < \\delta$", "$|f(x_1) - f(x_2)| < \\varepsilon$"],
                distractors: ["לכל", "$|x_1 - x_2| < \\varepsilon$", "בלתי תלוי ב-$x$", "תלוי ב-$x$", "רציפה", "קבועה", "$x_1 \\to x_2$"]
            },
            // Week 9: Cantor-Heine
            {
                id: 11,
                title: "משפט קנטור-היינה",
                template: `פונקציה {{0}} בקטע {{1}} היא {{2}} בו.`,
                answers: ["רציפה", "סגור", "רציפה במידה שווה"],
                distractors: ["גזירה", "פתוח", "חסומה", "קבועה", "מונוטונית", "אינטגרבילית", "רציפה למקוטעין"]
            },
            // Week 9: Derivative Definition
            {
                id: 12,
                title: "הגדרת הנגזרת",
                template: `הנגזרת של $f$ בנקודה $x_0$ היא הגבול של המנה {{0}} כאשר {{1}} (אם הגבול קיים).`,
                answers: ["$\\frac{f(x) - f(x_0)}{x - x_0}$", "$x \\to x_0$"],
                distractors: ["$\\frac{f(x) + f(x_0)}{x - x_0}$", "$x \\to 0$", "$\\frac{f(x) - f(x_0)}{h}$", "רציפה", "$x \\to \\infty$", "$\\Delta y$"]
            },
            // Week 10: Fermat's Theorem
            {
                id: 13,
                title: "משפט פרמה",
                template: `תהי $f$ מוגדרת בסביבת $x_0$. אם $f$ {{0}} ב-$x_0$ ויש לה בנקודה זו {{1}} (מקומי), אזי {{2}}.`,
                answers: ["גזירה", "קיצון", "$f'(x_0) = 0$"],
                distractors: ["רציפה", "משיק", "$f'(x_0) > 0$", "חיובית", "קמורה", "נקודת פיתול", "לא גזירה"]
            },
            // Week 10: Rolle's Theorem
            {
                id: 14,
                title: "משפט רול",
                template: `תהי $f$ רציפה ב-$[a,b]$, {{0}} ב-$(a,b)$ ומקיימת {{1}}. אזי קיימת $c \\in (a,b)$ כך ש-{{2}}.`,
                answers: ["גזירה", "$f(a) = f(b)$", "$f'(c) = 0$"],
                distractors: ["מונוטונית", "$f(a) \\cdot f(b) < 0$", "$f(c) = 0$", "אינטגרבילית", "קבועה", "שווה"]
            },
            // Week 10: Lagrange Mean Value
            {
                id: 15,
                title: "משפט הערך הממוצע של לגרנז'",
                template: `תהי $f$ רציפה ב-$[a,b]$ וגזירה ב-$(a,b)$. אזי קיימת $c \\in (a,b)$ כך ש-{{0}}.`,
                answers: ["$f'(c) = \\frac{f(b) - f(a)}{b - a}$"],
                distractors: ["$f'(c) = 0$", "$f(c) = \\frac{f(b) + f(a)}{2}$", "$f'(c) = f(b) - f(a)$", "ממוצע", "$f'(c) > 0$"]
            },
            // Week 10: Cauchy Mean Value
            {
                id: 16,
                title: "משפט הערך הממוצע של קושי",
                template: `תהיינה $f,g$ רציפות ב-$[a,b]$ וגזירות ב-$(a,b)$, ו-$g'(x) \\neq 0$. אזי קיימת $c$ כך ש-{{0}}.`,
                answers: ["$\\frac{f'(c)}{g'(c)} = \\frac{f(b) - f(a)}{g(b) - g(a)}$"],
                distractors: ["$f'(c) = g'(c)$", "$\\frac{f(c)}{g(c)} = \\frac{f(b)}{g(b)}$", "$\\frac{f'(c)}{g'(c)} = \\frac{f(b)}{g(b)}$", "$f(c) = g(c)$"]
            },
            // Week 11: Darboux Theorem (Derivative Property)
            {
                id: 17,
                title: "משפט דרבו (תכונת הנגזרת)",
                template: `אם $f$ גזירה בקטע, אזי הפונקציה הנגזרת $f'$ מקבלת כל {{0}} בין {{1}}.`,
                answers: ["ערך", "$f'(a)$ ל-$f'(b)$"],
                distractors: ["נקודה", "$f(a)$ ל-$f(b)$", "מקסימום", "סימן", "רציפה", "חיובי"]
            },
            // Week 12: Taylor's Theorem
            {
                id: 18,
                title: "משפט טיילור",
                template: `תהי $f$ גזירה $n+1$ פעמים. אזי $f(x) = P_n(x) + R_n(x)$ כאשר $P_n$ הוא {{0}} ו-$R_n$ הוא {{1}}.`,
                answers: ["פולינום טיילור", "השארית"],
                distractors: ["הנגזרת", "הגבול", "טור חזקות", "אינטגרל", "סדרת קושי", "המשיק"]
            },
            // Week 13: Convexity
            {
                id: 19,
                title: "הגדרת קמירות (כלפי מעלה)",
                template: `פונקציה נקראת קמורה אם לכל $x_1, x_2$ ולכל $0 < t < 1$ מתקיים {{0}}.`,
                answers: ["$f(tx_1 + (1-t)x_2) \\le tf(x_1) + (1-t)f(x_2)$"],
                distractors: ["$f(tx_1 + (1-t)x_2) \\ge tf(x_1) + (1-t)f(x_2)$", "$f'(x) > 0$", "לינארית", "מונוטונית", "$f''(x) < 0$"]
            },
            // Week 13: Inflection Point
            {
                id: 20,
                title: "נקודת פיתול",
                template: `נקודה שבה הפונקציה עוברת מ-{{0}} ל-{{1}} (או להפך) נקראת נקודת פיתול.`,
                answers: ["קמירות", "קעירות"],
                distractors: ["עלייה", "ירידה", "חיוביות", "שליליות", "רציפות", "גזירות"]
            }
        ];

        // --- State Management ---
        let currentLevelIndex = 0;
        let placedItems = {}; // Map slot index to word content
        let selectedItem = null; // For click-to-place logic

        // --- DOM Elements ---
        const board = document.getElementById('game-board');
        const sentenceContainer = document.getElementById('sentence-container');
        const wordBank = document.getElementById('word-bank');
        const feedbackEl = document.getElementById('feedback');
        const levelIndicator = document.getElementById('level-indicator');
        const nextBtn = document.getElementById('next-btn');
        const endScreen = document.getElementById('end-screen');

        // --- Initialization ---
        function initGame() {
            currentLevelIndex = 0;
            endScreen.classList.add('hidden');
            board.classList.remove('hidden');
            loadLevel(currentLevelIndex);
        }

        // --- Level Loading ---
        function loadLevel(index) {
            const level = levels[index];
            levelIndicator.innerText = index + 1;
            placedItems = {};
            selectedItem = null;
            feedbackEl.innerText = "";
            feedbackEl.className = "h-8 text-center font-bold text-lg mb-4";
            nextBtn.classList.add('hidden');

            let htmlContent = level.template;
            level.answers.forEach((ans, i) => {
                const slotHtml = `<span class="drop-zone" data-index="${i}" ondragover="allowDrop(event)" ondrop="drop(event)" onclick="handleSlotClick(${i})"></span>`;
                htmlContent = htmlContent.replace(`{{${i}}}`, slotHtml);
            });
            
            htmlContent = `<div class="text-blue-600 font-bold text-lg mb-2 text-right border-b border-blue-100 pb-2">${level.title}</div>` + htmlContent;
            sentenceContainer.innerHTML = htmlContent;

            // Prepare words with ID
            const bankItems = [];
            level.answers.forEach(a => bankItems.push({text: a, type: 'correct'}));
            level.distractors.forEach(d => bankItems.push({text: d, type: 'distractor'}));
            
            // Shuffle
            shuffleArray(bankItems);

            wordBank.innerHTML = "";
            bankItems.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "draggable-item bg-white border border-blue-300 rounded px-4 py-2 font-medium text-blue-800 hover:bg-blue-50 select-none cursor-pointer";
                div.draggable = true;
                div.innerHTML = item.text;
                // Store the raw text as the 'value' for comparison
                div.setAttribute('data-value', item.text); 
                
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData("text", item.text); // Send raw text
                    if(selectedItem) { selectedItem.classList.remove('selected'); selectedItem = null; }
                });
                
                div.addEventListener('click', (e) => {
                    // Selection logic
                    if (elementIsSlot(div)) return; // prevent clicking inside slot triggering selection logic wrongly
                    document.querySelectorAll('.draggable-item').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedItem = div;
                });
                
                wordBank.appendChild(div);
            });

            // Ensure MathJax renders the new content
            if (window.MathJax) {
                MathJax.typesetPromise([sentenceContainer, wordBank]).then(() => {
                    // Optional: adjustments after render
                });
            }
        }

        function elementIsSlot(el) {
            return el.closest('.drop-zone') !== null;
        }

        // --- Interactions (Drag & Drop + Click) ---

        let draggedContent = null;
        let draggedElement = null;

        function drag(ev) {
            const rawValue = ev.target.getAttribute('data-value');
            ev.dataTransfer.setData("text/plain", rawValue);
            
            draggedContent = ev.target.innerHTML; // Visual content
            draggedElement = ev.target;
            
            if(selectedItem) {
                selectedItem.classList.remove('selected');
                selectedItem = null;
            }
        }

        function allowDrop(ev) {
            ev.preventDefault();
            ev.target.classList.add('hovered');
        }

        function drop(ev) {
            ev.preventDefault();
            const slot = ev.target.closest('.drop-zone');
            slot.classList.remove('hovered');
            
            if (!slot) return;

            // We get the raw value
            const rawValue = ev.dataTransfer.getData("text/plain");
            placeWordInSlot(slot, rawValue);
        }

        function handleWordClick(e, element) {
            if (element.parentElement.id !== 'word-bank') return;

            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            
            selectedItem = element;
            selectedItem.classList.add('selected');
        }

        function handleSlotClick(slotIndex) {
            const slot = document.querySelector(`.drop-zone[data-index="${slotIndex}"]`);
            
            // If we have a selected word from the bank, place it
            if (selectedItem) {
                const rawValue = selectedItem.getAttribute('data-value');
                placeWordInSlot(slot, rawValue);
                selectedItem.classList.remove('selected');
                selectedItem = null;
            } else if (placedItems[slotIndex]) {
                clearSlot(slot, slotIndex);
            }
        }

        function placeWordInSlot(slot, rawContent) {
            const index = slot.getAttribute('data-index');
            
            // Update Visuals - we insert raw text then typeset
            slot.innerText = rawContent;
            slot.setAttribute('data-value', rawContent); // Store raw for checking
            
            slot.style.borderStyle = "solid";
            slot.style.backgroundColor = "#eff6ff";
            
            // Store Data
            placedItems[index] = rawContent;

            // Re-render Math in the slot
            if (window.MathJax) {
                MathJax.typesetPromise([slot]);
            }
        }

        function clearSlot(slot, index) {
            slot.innerHTML = "";
            slot.removeAttribute('data-value');
            slot.style.borderStyle = "dashed";
            slot.style.backgroundColor = "#eef2ff";
            delete placedItems[index];
            
            slot.classList.remove('correct', 'wrong');
        }

        // --- Game Logic ---

        function checkAnswer() {
            const level = levels[currentLevelIndex];
            let allCorrect = true;
            let filledCount = 0;

            level.answers.forEach((ans, i) => {
                const slot = document.querySelector(`.drop-zone[data-index="${i}"]`);
                const userValue = placedItems[i]; // This is raw text now

                if (!userValue) {
                    allCorrect = false;
                    slot.classList.add('wrong');
                    return;
                }
                filledCount++;

                // Compare raw strings
                const isMatch = checkMatch(userValue, ans);

                if (isMatch) {
                    slot.classList.add('correct');
                    slot.classList.remove('wrong');
                } else {
                    slot.classList.add('wrong');
                    slot.classList.remove('correct');
                    allCorrect = false;
                }
            });

            if (filledCount < level.answers.length) {
                feedbackEl.innerText = "נא למלא את כל החסר";
                feedbackEl.className = "text-yellow-600 font-bold mb-4";
                return;
            }

            if (allCorrect) {
                feedbackEl.innerText = "כל הכבוד! תשובה נכונה.";
                feedbackEl.className = "text-green-600 font-bold mb-4 text-xl";
                nextBtn.classList.remove('hidden');
                triggerConfetti();
            } else {
                feedbackEl.innerText = "יש טעות, נסו שוב.";
                feedbackEl.className = "text-red-600 font-bold mb-4";
                setTimeout(() => {
                    document.querySelectorAll('.wrong').forEach(el => el.classList.remove('wrong')); 
                }, 500);
            }
        }

        // Redefine checkMatch to be simple string comparison
        function checkMatch(userValue, correctValue) {
            return userValue.trim() === correctValue.trim();
        }
        
        // --- Navigation ---

        function nextLevel() {
            if (currentLevelIndex < levels.length - 1) {
                currentLevelIndex++;
                loadLevel(currentLevelIndex);
            } else {
                showEndScreen();
            }
        }

        function resetLevel() {
            loadLevel(currentLevelIndex);
        }

        function showEndScreen() {
            board.classList.add('hidden');
            endScreen.classList.remove('hidden');
            endScreen.classList.add('fade-in');
            triggerConfetti();
        }

        function restartGame() {
            initGame();
        }

        // Utils
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // Start
        window.onload = initGame;

    </script>
</body>
</html>
